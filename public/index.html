<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Best Cart Deal Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
            position: relative;
        }
        
        .section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-add {
            background: #4CAF50;
        }
        
        .btn-add:hover {
            background: #45a049;
        }
        
        .btn-remove {
            background: #333333;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .btn-remove:hover {
            background: #d32f2f;
        }
        
        .btn-clear {
            background: #FF9800;
        }
        
        .btn-clear:hover {
            background: #F57C00;
        }
        
        .btn-calculate {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            font-size: 18px;
            padding: 15px 30px;
            margin: 20px 0;
            width: 100%;
        }
        
        .btn-calculate:hover {
            background: linear-gradient(45deg, #FF5252, #FF7043);
        }
        
        .item-row, .vendor-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .item-row input {
            flex: 1;
        }
        
        .vendor-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .vendor-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .vendor-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .vendor-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .vendor-item span {
            min-width: 80px;
            font-weight: 500;
        }
        
        .result {
            margin-top: 30px;
            padding: 25px;
            border-radius: 10px;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .result-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-content {
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .selection-list {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.3);
            border-radius: 8px;
        }
        
        .comparison-table {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.4);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.6);
        }
        
        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        
        .comparison-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.5);
        }
        
        .vendor-name {
            font-weight: 600;
        }
        
        .vendor-total {
            font-weight: bold;
        }
        
        .optimal-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .savings-alert {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(45deg, #FFE082, #FFCC02);
            border: 2px solid #FFA000;
            border-radius: 8px;
            color: #E65100;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #2196F3;
            font-size: 1.2em;
            margin: 20px 0;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .clear-section {
            text-align: right;
            margin-bottom: 15px;
        }
        
        .selected-vendor {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4CAF50 !important;
        }
        
        @media (max-width: 768px) {
            .comparison-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .vendor-header {
                flex-direction: column;
            }
            
            .vendor-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛒 Best Cart Deal Calculator</h1>
            <p>Find the cheapest way to buy your items across multiple vendors!</p>
        </div>
        
        <div class="content">
            <!-- Shopping Cart Items Section -->
            <div class="section">
                <h3>🛍️ Shopping Cart Items</h3>
                <div class="clear-section">
                    <button class="btn btn-clear" onclick="clearAllItems()">🗑️ Clear All Items</button>
                </div>
                <div id="cartItems">
                    <div class="item-row">
                        <input type="text" placeholder="Enter item name..." value="Laptop">
                        <button class="btn btn-remove" onclick="removeCartItem(this)">❌</button>
                    </div>
                    <div class="item-row">
                        <input type="text" placeholder="Enter item name..." value="Mouse">
                        <button class="btn btn-remove" onclick="removeCartItem(this)">❌</button>
                    </div>
                    <div class="item-row">
                        <input type="text" placeholder="Enter item name..." value="Keyboard">
                        <button class="btn btn-remove" onclick="removeCartItem(this)">❌</button>
                    </div>
                </div>
                <button class="btn btn-add" onclick="addCartItem()">➕ Add Item</button>
            </div>
            
            <!-- Vendors Section -->
            <div class="section">
                <h3>🏪 Vendors 
                    <span class="tooltip">ℹ️
                        <span class="tooltiptext">Shipping fee is charged once per vendor, regardless of how many items you buy from them</span>
                    </span>
                </h3>
                <div class="clear-section">
                    <button class="btn btn-clear" onclick="clearAllVendors()">🗑️ Clear All Vendors</button>
                </div>
                <div id="vendors">
                    <!-- Vendor 1 -->
                    <div class="vendor-section">
                        <div class="vendor-header">
                            <input type="text" placeholder="Vendor name..." value="TechStore" style="flex: 2;">
                            <input type="number" placeholder="Shipping fee..." value="20" style="flex: 1;" min="0" step="0.01">
                            <button class="btn btn-remove" onclick="removeVendor(this)">❌</button>
                        </div>
                        <div class="vendor-items"></div>
                    </div>
                    
                    <!-- Vendor 2 -->
                    <div class="vendor-section">
                        <div class="vendor-header">
                            <input type="text" placeholder="Vendor name..." value="ElectroMart" style="flex: 2;">
                            <input type="number" placeholder="Shipping fee..." value="15" style="flex: 1;" min="0" step="0.01">
                            <button class="btn btn-remove" onclick="removeVendor(this)">❌</button>
                        </div>
                        <div class="vendor-items"></div>
                    </div>
                </div>
                <button class="btn btn-add" onclick="addVendor()">🏪 Add Vendor</button>
            </div>
            
            <!-- Calculate Button -->
            <button class="btn btn-calculate" onclick="calculateBestDeal()">
                🧮 Calculate Best Deal
            </button>
            
            <!-- Loading Animation -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                Calculating the best deal for you...
            </div>
            
            <!-- Results Section -->
            <div class="result" id="result">
                <div class="result-header" id="resultHeader"></div>
                <div class="result-content" id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        // API endpoint - dynamically uses current protocol for localhost
        const API_URL = window.location.hostname === 'localhost' 
            ? `${window.location.protocol}//localhost:3000/best-deal`
            : 'https://best-cart-deal-calculator.onrender.com/best-deal';

        
        /**
         * Add a new cart item input field
         */
        function addCartItem() {
            const cartItems = document.getElementById('cartItems');
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                <input type="text" placeholder="Enter item name...">
                <button class="btn btn-remove" onclick="removeCartItem(this)">❌</button>
            `;
            cartItems.appendChild(itemRow);
            updateVendorItems();
        }
        
        /**
         * Remove a cart item
         */
        function removeCartItem(button) {
            button.parentElement.remove();
            updateVendorItems();
        }
        
        /**
         * Clear all cart items
         */
        function clearAllItems() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            addCartItem(); // Add one empty item
            updateVendorItems();
        }
        
        /**
         * Add a new vendor section
         */
        function addVendor() {
            const vendors = document.getElementById('vendors');
            const vendorSection = document.createElement('div');
            vendorSection.className = 'vendor-section';
            vendorSection.innerHTML = `
                <div class="vendor-header">
                    <input type="text" placeholder="Vendor name..." style="flex: 2;">
                    <input type="number" placeholder="Shipping fee..." min="0" step="0.01" style="flex: 1;">
                    <button class="btn btn-remove" onclick="removeVendor(this)">❌</button>
                </div>
                <div class="vendor-items"></div>
            `;
            vendors.appendChild(vendorSection);
            updateVendorItems();
        }
        
        /**
         * Remove a vendor
         */
        function removeVendor(button) {
            button.closest('.vendor-section').remove();
        }
        
        /**
         * Clear all vendors
         */
        function clearAllVendors() {
            const vendors = document.getElementById('vendors');
            vendors.innerHTML = '';
            addVendor(); // Add one empty vendor
        }
        
        /**
         * Update vendor item price inputs based on cart items
         */
        function updateVendorItems() {
            // Get all cart items
            const cartInputs = document.querySelectorAll('#cartItems input[type="text"]');
            const items = Array.from(cartInputs).map(input => input.value.trim()).filter(item => item);
            
            // Update each vendor's item inputs
            const vendorSections = document.querySelectorAll('.vendor-section');
            vendorSections.forEach(section => {
                const vendorItems = section.querySelector('.vendor-items');
                const existingInputs = {};
                
                // Save existing values
                const existingPriceInputs = vendorItems.querySelectorAll('input[type="number"]');
                existingPriceInputs.forEach(input => {
                    const itemName = input.previousElementSibling.textContent;
                    existingInputs[itemName] = input.value;
                });
                
                // Clear and rebuild
                vendorItems.innerHTML = '';
                
                items.forEach(item => {
                    const vendorItem = document.createElement('div');
                    vendorItem.className = 'vendor-item';
                    vendorItem.innerHTML = `
                        <span>${item}:</span>
                        <input type="number" placeholder="Price" min="0" step="0.01" value="${existingInputs[item] || ''}">
                    `;
                    vendorItems.appendChild(vendorItem);
                });
            });
        }
        
        /**
         * Sanitize and validate input data
         */
        function sanitizeInput(str) {
            return str.trim().replace(/[<>]/g, '');
        }
        
        /**
         * Collect form data and convert to API format
         */
        function collectFormData() {
            // Get cart items
            const cartInputs = document.querySelectorAll('#cartItems input[type="text"]');
            const cart = Array.from(cartInputs)
                .map(input => sanitizeInput(input.value))
                .filter(item => item);
            
            if (cart.length === 0) {
                throw new Error('Please add at least one item to your cart');
            }
            
            // Get vendors
            const vendors = [];
            const vendorSections = document.querySelectorAll('.vendor-section');
            
            vendorSections.forEach(section => {
                const nameInput = section.querySelector('.vendor-header input[type="text"]');
                const shippingInput = section.querySelector('.vendor-header input[type="number"]');
                
                const name = sanitizeInput(nameInput.value);
                const shipping = parseFloat(shippingInput.value) || 0;
                
                if (!name) return; // Skip vendors without names
                
                const items = {};
                const itemInputs = section.querySelectorAll('.vendor-items input[type="number"]');
                itemInputs.forEach(input => {
                    const itemName = input.previousElementSibling.textContent.replace(':', '');
                    const price = parseFloat(input.value);
                    if (!isNaN(price) && price >= 0) {
                        items[itemName] = price;
                    }
                });
                
                vendors.push({ name, shipping, items });
            });
            
            if (vendors.length === 0) {
                throw new Error('Please add at least one vendor with prices');
            }
            
            // Check if all cart items have at least one vendor price
            for (const item of cart) {
                const hasPrice = vendors.some(vendor => vendor.items[item] !== undefined);
                if (!hasPrice) {
                    throw new Error(`Item "${item}" has no price from any vendor`);
                }
            }
            
            return { cart, vendors };
        }
        
        /**
         * Calculate comparison data for all vendors
         */
        function calculateComparisons(cart, vendors, optimalTotal) {
            const comparisons = [];
            
            vendors.forEach(vendor => {
                let totalItems = 0;
                let availableItems = 0;
                
                cart.forEach(item => {
                    if (vendor.items[item] !== undefined) {
                        totalItems += vendor.items[item];
                        availableItems++;
                    }
                });
                
                // Only show comparison if vendor has all items
                if (availableItems === cart.length) {
                    const total = totalItems + vendor.shipping;
                    comparisons.push({
                        name: vendor.name,
                        itemsTotal: totalItems,
                        shipping: vendor.shipping,
                        total: total
                    });
                }
            });
            
            // Sort by total cost
            comparisons.sort((a, b) => a.total - b.total);
            
            return comparisons;
        }
        
        /**
         * Highlight selected vendors in the UI
         */
        function highlightSelectedVendors(selection) {
            // Reset all vendor sections
            const vendorSections = document.querySelectorAll('.vendor-section');
            vendorSections.forEach(section => {
                section.classList.remove('selected-vendor');
            });
            
            // Highlight selected vendors
            const selectedVendors = new Set(Object.values(selection));
            vendorSections.forEach(section => {
                const vendorName = section.querySelector('.vendor-header input[type="text"]').value.trim();
                if (selectedVendors.has(vendorName)) {
                    section.classList.add('selected-vendor');
                }
            });
        }
        
        /**
         * Calculate the best deal
         */
        async function calculateBestDeal() {
            const resultDiv = document.getElementById('result');
            const resultHeader = document.getElementById('resultHeader');
            const resultContent = document.getElementById('resultContent');
            const loading = document.getElementById('loading');
            const calculateBtn = document.querySelector('.btn-calculate');
            
            // Hide previous results and show loading
            resultDiv.style.display = 'none';
            loading.style.display = 'block';
            calculateBtn.disabled = true;
            
            try {
                // Collect and validate form data
                const data = collectFormData();
                
                // Make API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to calculate best deal');
                }
                
                // Highlight selected vendors
                highlightSelectedVendors(result.selection);
                
                // Calculate comparisons
                const comparisons = calculateComparisons(data.cart, data.vendors, result.cheapest_total);
                
                // Display success result
                resultDiv.className = 'result success';
                resultHeader.innerHTML = '🎉 Best Deal Found!';
                
                let content = `
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                        💰 Optimal Total: $${result.cheapest_total.toFixed(2)}
                    </div>
                `;
                
                content += '<div class="selection-list">';
                content += '<strong>📦 Optimal Vendor Selection:</strong><br>';
                
                for (const [item, vendor] of Object.entries(result.selection)) {
                    content += `<div style="margin: 5px 0;">• ${item} → <strong>${vendor}</strong></div>`;
                }
                
                content += '</div>';
                
                // Add comparison table
                if (comparisons.length > 1) {
                    content += '<div class="comparison-table">';
                    content += '<strong>📊 Vendor Comparison (if buying all from one vendor):</strong><br><br>';
                    
                    comparisons.forEach(comp => {
                        const isOptimal = comp.total === Math.min(...comparisons.map(c => c.total));
                        content += `
                            <div class="comparison-row">
                                <span class="vendor-name">${comp.name}:</span>
                                <span class="vendor-total">$${comp.total.toFixed(2)} 
                                    <small>(items: $${comp.itemsTotal.toFixed(2)} + shipping: $${comp.shipping.toFixed(2)})</small>
                                    ${isOptimal && comp.total > result.cheapest_total ? '<span class="optimal-badge">Cheapest Single Vendor</span>' : ''}
                                </span>
                            </div>
                        `;
                    });
                    
                    content += `
                        <div class="comparison-row">
                            <span class="vendor-name">✅ Optimal Mix:</span>
                            <span class="vendor-total">$${result.cheapest_total.toFixed(2)} <span class="optimal-badge">BEST</span></span>
                        </div>
                    `;
                    
                    content += '</div>';
                }
                
                // Add savings alert if significant
                const cheapestSingleVendor = Math.min(...comparisons.map(c => c.total));
                const savings = cheapestSingleVendor - result.cheapest_total;
                
                if (savings > 0.01) {
                    content += `
                        <div class="savings-alert">
                            💡 <strong>Smart Shopping Alert:</strong> You're saving $${savings.toFixed(2)} compared to buying everything from a single vendor!
                        </div>
                    `;
                } else if (comparisons.length > 1) {
                    const maxVendorCost = Math.max(...comparisons.map(c => c.total));
                    const totalSavings = maxVendorCost - result.cheapest_total;
                    if (totalSavings > 5) {
                        content += `
                            <div class="savings-alert">
                                💡 <strong>Pro Tip:</strong> You're saving $${totalSavings.toFixed(2)} compared to the most expensive vendor!
                            </div>
                        `;
                    }
                }
                
                resultContent.innerHTML = content;
                resultDiv.style.display = 'block';
                
            } catch (error) {
                // Display error
                resultDiv.className = 'result error';
                resultHeader.innerHTML = '❌ Error';
                resultContent.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
                
                console.error('Error:', error);
            } finally {
                // Hide loading and re-enable button
                loading.style.display = 'none';
                calculateBtn.disabled = false;
            }
        }
        
        // Initialize vendor items when page loads
        window.addEventListener('load', function() {
            updateVendorItems();
            
            // Add some example prices
            const vendorSections = document.querySelectorAll('.vendor-section');
            if (vendorSections.length >= 2) {
                // TechStore prices
                const techStoreInputs = vendorSections[0].querySelectorAll('.vendor-items input[type="number"]');
                if (techStoreInputs.length >= 3) {
                    techStoreInputs[0].value = '899'; // Laptop
                    techStoreInputs[1].value = '35';  // Mouse
                    techStoreInputs[2].value = '75';  // Keyboard
                }
                
                // ElectroMart prices
                const electroInputs = vendorSections[1].querySelectorAll('.vendor-items input[type="number"]');
                if (electroInputs.length >= 3) {
                    electroInputs[0].value = '950'; // Laptop
                    electroInputs[1].value = '28';  // Mouse
                    electroInputs[2].value = '65';  // Keyboard
                }
            }
        });
        
        // Update vendor items when cart items change
        document.getElementById('cartItems').addEventListener('input', function(e) {
            if (e.target.type === 'text') {
                setTimeout(updateVendorItems, 100); // Small delay to allow input to update
            }
        });
    </script>
</body>
</html>